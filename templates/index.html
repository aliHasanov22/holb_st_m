<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Planner Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .completed { text-decoration: line-through; color: #adb5bd; }
        .card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-radius: 12px; }
        .priority-High { border-left: 5px solid #dc3545; }
        .priority-Medium { border-left: 5px solid #ffc107; }
        .priority-Low { border-left: 5px solid #0d6efd; }
        .timer-display { font-family: 'Courier New', Courier, monospace; font-weight: bold; font-size: 2rem; }
        /* Table Styles */
        .table-sm td, .table-sm th { font-size: 0.85rem; vertical-align: middle; }
    </style>
</head>
<body>

{% raw %}
<div id="app" class="container mt-4" style="max-width: 950px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ðŸŽ“ Student Planner</h2>
        <span class="badge bg-dark">v1.2</span>
    </div>

    <div class="row">
        <div class="col-md-7">
            
            <div class="card p-4 mb-4 bg-white border-primary border-2">
                <h5 class="text-primary"><i class="fas fa-stopwatch me-2"></i>Focus Session</h5>
                <div class="d-flex align-items-center gap-2">
                    <input v-model="studySubject" :disabled="timerRunning" type="text" class="form-control" placeholder="Subject...">
                    <div class="fw-bold fs-4">{{ formattedTime }}</div>
                    <button v-if="!timerRunning" @click="startTimer" class="btn btn-success btn-sm"><i class="fas fa-play"></i></button>
                    <button v-if="timerRunning" @click="stopTimer" class="btn btn-danger btn-sm"><i class="fas fa-stop"></i></button>
                </div>
            </div>

            <div class="card p-3 mb-4">
                <h5 class="mb-3 text-muted">Add Task</h5>
                <div class="row g-2">
                    <div class="col-6"><input v-model="newTask" @keyup.enter="addTask" type="text" class="form-control" placeholder="Title..."></div>
                    <div class="col-3"><input v-model="newDueDate" type="date" class="form-control"></div>
                    <div class="col-3"><button @click="addTask" class="btn btn-primary w-100">Add</button></div>
                </div>
            </div>

            <div v-for="task in tasks" :key="task.id" class="card mb-2 p-2 px-3 d-flex flex-row justify-content-between align-items-center" :class="'priority-' + task.priority">
                <div>
                    <input class="form-check-input me-2" type="checkbox" :checked="task.status === 'Completed'" @change="toggleTask(task)">
                    <span :class="{ completed: task.status === 'Completed' }">{{ task.title }}</span>
                    <small class="text-muted ms-2" v-if="task.due_date">({{ task.due_date }})</small>
                </div>
                <button @click="deleteTask(task.id)" class="btn btn-sm text-danger"><i class="fas fa-trash"></i></button>
            </div>
        </div>

        <div class="col-md-5">
            
            <div class="card p-4 mb-4">
                <h5 class="text-dark"><i class="fas fa-university me-2"></i>Campus Attendance</h5>
                <p class="text-muted small mb-2">Weekdays 08:00 - 18:00 only.</p>

                <div class="bg-light p-3 rounded mb-3">
                    <div class="mb-2">
                        <label class="small text-muted">Date</label>
                        <input v-model="attDate" type="date" class="form-control form-control-sm">
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="small text-muted">Entry</label>
                            <input v-model="attEntry" type="time" class="form-control form-control-sm">
                        </div>
                        <div class="col-6">
                            <label class="small text-muted">Exit</label>
                            <input v-model="attExit" type="time" class="form-control form-control-sm">
                        </div>
                    </div>
                    <button @click="addAttendance" class="btn btn-dark w-100 btn-sm">Log Time</button>
                </div>

                <label class="fw-bold d-flex justify-content-between small mb-1">
                    <span>Weekly Progress</span>
                    <span>{{ attendanceHours }} / 15 hrs</span>
                </label>
                <div class="progress mb-3" style="height: 15px;">
                    <div class="progress-bar" 
                         :class="attendanceHours >= 15 ? 'bg-success' : 'bg-warning'" 
                         role="progressbar" 
                         :style="{ width: attendancePercent + '%' }">
                    </div>
                </div>

                <h6 class="border-bottom pb-2">This Week's Logs</h6>
                <div style="max-height: 200px; overflow-y: auto;">
                    <table class="table table-sm table-hover text-center">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Valid Hrs</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="log in attendanceLogs" :key="log.date + log.entry">
                                <td>{{ log.date.slice(5) }}</td> <td class="small text-muted">{{ log.entry }} - {{ log.exit }}</td>
                                <td class="fw-bold text-success">{{ log.hours }}</td>
                            </tr>
                            <tr v-if="attendanceLogs.length === 0">
                                <td colspan="3" class="text-muted small">No logs yet this week.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div v-if="attendanceHours < 15" class="alert alert-danger py-2 small mt-2">
                    <i class="fas fa-exclamation-triangle me-1"></i> 
                    Missing <b>{{ (15 - attendanceHours).toFixed(1) }}</b> hours.
                </div>
            </div>

        </div>
    </div>
</div>
{% endraw %}

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    const { createApp } = Vue;

    const app = createApp({
        data() {
            return {
                tasks: [],
                newTask: '', newPriority: 'Medium', newDueDate: '',
                studySubject: '', timerSeconds: 0, timerRunning: false, timerInterval: null,
                
                // Attendance Data
                attDate: new Date().toISOString().split('T')[0], // Default to Today
                attEntry: '',
                attExit: '',
                attendanceHours: 0,
                attendanceLogs: [] // Stores the history list
            }
        },
        computed: {
            pendingCount() { return this.tasks.filter(t => t.status === 'Pending').length },
            formattedTime() {
                const mins = Math.floor(this.timerSeconds / 60).toString().padStart(2, '0');
                const secs = (this.timerSeconds % 60).toString().padStart(2, '0');
                return `${mins}:${secs}`;
            },
            attendancePercent() {
                return Math.min(100, (this.attendanceHours / 15) * 100);
            }
        },
        methods: {
            async fetchTasks() {
                const res = await fetch('/api/tasks');
                this.tasks = await res.json();
            },
            async addTask() {
                if (!this.newTask) return;
                const res = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ title: this.newTask, priority: this.newPriority, due_date: this.newDueDate })
                });
                this.tasks.unshift(await res.json());
                this.newTask = '';
            },
            async toggleTask(task) {
                const res = await fetch(`/api/tasks/${task.id}/toggle`, { method: 'PUT' });
                task.status = (await res.json()).status;
            },
            async deleteTask(id) {
                await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
                this.tasks = this.tasks.filter(t => t.id !== id);
            },
            startTimer() {
                this.timerRunning = true;
                this.timerInterval = setInterval(() => { this.timerSeconds++; }, 1000);
            },
            async stopTimer() {
                clearInterval(this.timerInterval);
                this.timerRunning = false;
                this.timerSeconds = 0;
            },
            
            // --- ATTENDANCE METHODS ---
            async fetchAttendance() {
                const res = await fetch('/api/attendance');
                const data = await res.json();
                this.attendanceHours = data.total_hours;
                this.attendanceLogs = data.logs; // Save logs for the table
            },
            async addAttendance() {
                if (!this.attEntry || !this.attExit) return alert("Please enter both times.");
                
                const res = await fetch('/api/attendance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        date: this.attDate,
                        entry: this.attEntry, 
                        exit: this.attExit 
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    // Show error (e.g., Weekend)
                    alert(data.error || "Error logging time");
                } else if (data.hours === 0) {
                    alert("Logged, but 0 valid hours. (Outside 8am-6pm range?)");
                    this.fetchAttendance(); 
                } else {
                    this.fetchAttendance(); 
                }
                
                // Keep date, clear times for next entry
                this.attEntry = '';
                this.attExit = '';
            }
        },
        mounted() {
            this.fetchTasks();
            this.fetchAttendance(); 
        }
    });

    app.config.compilerOptions.delimiters = ['[[', ']]'];
    app.mount('#app');
</script>
</body>
</html>
